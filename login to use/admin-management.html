<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Management - RFID Attendance System</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="fst.png">
  <!-- Google Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="home.css">
  <link rel="stylesheet" href="menu.css">
  <link rel="stylesheet" href="sharedcss.css">
  <script src="theme.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-admin-helper.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
  <!-- Sliding Menu -->
  <div class="menu">
    <ul class="menu-content">
      <li><a href="home1.html"><span class="material-symbols-outlined">home</span><span>Home</span></a></li>
      <li><a href="dashboard.html"><span class="material-symbols-outlined">dashboard</span><span>Dashboard</span></a></li>
      <li><a href="explore.html"><span class="material-symbols-outlined">explore</span><span>Explore</span></a></li>
      <li><a href="analytics.html"><span class="material-symbols-outlined">analytics</span><span>Analytics</span></a></li>
      <li><a href="settings.html"><span class="material-symbols-outlined">settings</span><span>Settings</span></a></li>
      <li><a href="profile.html"><span class="material-symbols-outlined">person</span><span>Account</span></a></li>
      <li><a href="report.html"><span class="material-symbols-outlined">report</span><span>Report</span></a></li>
      <li><a href="contact.html"><span class="material-symbols-outlined">email</span><span>Contact</span></a></li>
      <li><a href="admin-management.html" class="active"><span class="material-symbols-outlined">admin_panel_settings</span><span>Admin Management</span></a></li>
      <li><a href="#" id="menu-logout"><span class="material-symbols-outlined">logout</span><span>Logout</span></a></li>
    </ul>
  </div>

  <!-- Top Navigation -->
  <nav class="bg-white dark:bg-gray-800 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <img class="h-8 w-auto" src="fst.png" alt="Logo">
            <span class="ml-2 text-xl font-bold text-gray-800 dark:text-white">RFID Attendance System</span>
          </div>
        </div>
        <div class="flex items-center">
          <div class="relative ml-3">
            <button id="user-menu-btn" class="max-w-xs flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              <span class="sr-only">Open user menu</span>
              <img id="user-avatar" class="h-8 w-8 rounded-full object-cover" src="fst.png" alt="User avatar">
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Admin Management</h1>

    <!-- Add New Student Form -->
    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg mb-6">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Add New Student</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Fill out the form below to add a new student.</p>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-5 sm:p-6">
        <form id="add-student-form" class="space-y-4">
          <div>
            <label for="student-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
            <input type="text" id="student-name" name="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label for="student-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
            <input type="email" id="student-email" name="student-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label for="student-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
            <input type="text" id="student-password" name="student-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:text-white">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">This password will be used for student login</p>
          </div>
          <div>
            <label for="rfid-badge" class="block text-sm font-medium text-gray-700 dark:text-gray-300">RFID Badge Number</label>
            <input type="text" id="rfid-badge" name="rfid-badge" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-700 dark:text-white">
          </div>
          <div class="flex justify-end">
            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Add Student
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Interactive Table -->
    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Manage Students</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Use the table below to view, edit, or delete student records.</p>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700 px-4 py-5 sm:p-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">RFID Badge</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="student-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Dynamic rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAtj5j3xYmxRMOMR6ZOy8ucoqqhsD0jlZo",
      authDomain: "fdhf-4403b.firebaseapp.com",
      databaseURL: "https://fdhf-4403b-default-rtdb.firebaseio.com",
      projectId: "fdhf-4403b",
      storageBucket: "fdhf-4403b.appspot.com",
      messagingSenderId: "805654928789",
      appId: "1:805654928789:web:c7d541db0c1f92196e2a9c",
      measurementId: "G-KZNZ6JQ4FL",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Improve the createAuthAccount function with better error handling
    function createAuthAccount(email, password) {
      // Validate password length first
      if (password.length < 6) {
        return Promise.reject({
          message: "Password must be at least 6 characters long"
        });
      }
      
      // Get API key from your Firebase config
      const apiKey = firebaseConfig.apiKey;
      
      // Use Firebase Auth REST API directly
      return fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: email,
          password: password,
          returnSecureToken: true
        })
      })
      .then(response => {
        // Always parse the response body whether successful or not
        return response.json().then(data => {
          if (!response.ok) {
            // Format the error message more clearly
            const errorMessage = data.error && data.error.message 
              ? translateFirebaseError(data.error.message) 
              : "Authentication failed";
            
            console.error("Auth API error:", data);
            throw new Error(errorMessage);
          }
          return data;
        });
      })
      .then(data => {
        console.log("Authentication account created with UID:", data.localId);
        return data;
      });
    }

    // Helper function to translate Firebase error codes to user-friendly messages
    function translateFirebaseError(errorCode) {
      switch(errorCode) {
        case 'EMAIL_EXISTS':
          return 'This email address is already in use';
        case 'OPERATION_NOT_ALLOWED':
          return 'Email/password accounts are not enabled';
        case 'TOO_MANY_ATTEMPTS_TRY_LATER':
          return 'Too many attempts. Try again later';
        case 'WEAK_PASSWORD':
          return 'Password should be at least 6 characters';
        case 'INVALID_EMAIL':
          return 'Invalid email address format';
        default:
          return errorCode;
      }
    }

    // Add new student to Firestore or update existing student
    document.getElementById("add-student-form").addEventListener("submit", function (e) {
      e.preventDefault();

      const form = this;
      const name = document.getElementById("student-name").value;
      const email = document.getElementById("student-email").value;
      const password = document.getElementById("student-password").value;
      const rfid = document.getElementById("rfid-badge").value;
      
      // Check if we're in edit mode
      const isEditMode = form.dataset.mode === 'edit';
      const studentId = form.dataset.id;

      if (isEditMode && studentId) {
        // Update existing student
        db.collection("users").doc(studentId).update({
          name: name,
          email: email,
          rfid: rfid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          alert("Student updated successfully!");
          
          // Reset form back to "add" mode
          form.reset();
          delete form.dataset.mode;
          delete form.dataset.id;
          form.querySelector('button[type="submit"]').textContent = 'Add Student';
          
          // Refresh the table
          loadStudents();
        })
        .catch((error) => {
          console.error("Error updating student:", error);
          alert(`Error updating student: ${error.message}`);
        });
      } else {
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Creating account...";

        // First check if email already exists in Firestore
        db.collection("users")
          .where("email", "==", email)
          .get()
          .then((snapshot) => {
            if (!snapshot.empty) {
              throw new Error("A user with this email already exists in the database");
            }
            
            // Then create Authentication account
            return createAuthAccount(email, password);
          })
          .then((authData) => {
            // Extract the localId (UID) from the authentication response
            const authUid = authData.localId;
            
            if (!authUid) {
              throw new Error("Failed to get authentication user ID");
            }
            
            // Now create Firestore document with the SAME ID as the auth account
            return db.collection("users").doc(authUid).set({
              name: name,
              email: email,
              password: password,
              rfid: rfid,
              role: "student",
              uid: authUid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          })
          .then(() => {
            alert(`Student added successfully! They can login with:\nEmail: ${email}\nPassword: ${password}`);
            form.reset();
            loadStudents(); // Refresh the table
          })
          .catch((error) => {
            console.error("Error adding student:", error);
            alert(`Error adding student: ${error.message || "Unknown error"}`);
          })
          .finally(() => {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText || "Add Student";
          });
      }
    });

    // Modify the loadStudents function to use a different approach
    function loadStudents() {
      const tableBody = document.getElementById('student-table-body');
      tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">Loading students...</td></tr>';

      // Get current user's ID for security rules
      const userId = auth.currentUser ? auth.currentUser.uid : null;
      if (!userId) {
        tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">User not authenticated</td></tr>';
        return;
      }

      // Try a more basic approach first
      db.collection('users')
        .get()
        .then(snapshot => {
          tableBody.innerHTML = ''; // Clear loading message
          
          if (snapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No students found</td></tr>';
            return;
          }
          
          // Filter students client-side
          const students = snapshot.docs.filter(doc => doc.data().role === 'student');
          
          if (students.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No students found</td></tr>';
            return;
          }
          
          students.forEach(doc => {
            const student = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${student.name || ''}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${student.email || ''}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${student.rfid || ''}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-500 edit-btn" data-id="${doc.id}">Edit</button>
                <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-500 ml-4 delete-btn" data-id="${doc.id}">Delete</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
          
          // Add event listeners to the buttons after they're created
          addButtonEventListeners();
        })
        .catch(error => {
          console.error('Error loading students:', error);
          tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading students: ${error.message}</td></tr>`;
        });
    }

    // Function to add event listeners to the edit and delete buttons
    function addButtonEventListeners() {
      // Add event listeners for edit buttons
      document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
          const studentId = this.getAttribute('data-id');
          // Get the student data
          db.collection('users').doc(studentId).get()
            .then((doc) => {
              if (doc.exists) {
                const student = doc.data();
                // Show edit form/modal
                document.getElementById('student-name').value = student.name || '';
                document.getElementById('student-email').value = student.email || '';
                document.getElementById('student-password').value = student.password || '';
                document.getElementById('rfid-badge').value = student.rfid || '';
                
                // Change form submit to update instead of add
                const form = document.getElementById('add-student-form');
                form.dataset.mode = 'edit';
                form.dataset.id = studentId;
                
                // Update button text
                form.querySelector('button[type="submit"]').textContent = 'Update Student';
              }
            })
            .catch(error => {
              console.error('Error getting student:', error);
              alert(`Error getting student: ${error.message}`);
            });
        });
      });
      
      // Add event listeners for delete buttons
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
          const studentId = this.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this student? This will permanently remove all their data.')) {
            // First get the student data to check if they have an auth account
            db.collection('users').doc(studentId).get()
              .then((doc) => {
                if (!doc.exists) {
                  throw new Error('Student record not found');
                }
                
                const studentData = doc.data();
                const studentEmail = studentData.email;
                
                // We need to check if this student has an auth account
                // Ask admin for password to perform sensitive operations
                const adminPassword = prompt(
                  "To delete both the student record and authentication account, please enter your admin password:",
                  ""
                );
                
                if (!adminPassword) {
                  throw new Error('Password required to delete authentication accounts');
                }
                
                // Get current admin user
                const adminUser = auth.currentUser;
                if (!adminUser) {
                  throw new Error('Admin not authenticated');
                }
                
                // Re-authenticate admin to perform sensitive operations
                const credential = firebase.auth.EmailAuthProvider.credential(
                  adminUser.email,
                  adminPassword
                );
                
                return adminUser.reauthenticateWithCredential(credential)
                  .then(() => {
                    // Now attempt to find and delete the auth account
                    // First, let's check for Auth accounts with matching email
                    return auth.fetchSignInMethodsForEmail(studentEmail);
                  })
                  .then((methods) => {
                    // If we found sign-in methods, there's an Auth account
                    if (methods && methods.length > 0) {
                      // Create a temporary user with the student credentials
                      return auth.signInWithEmailAndPassword(studentEmail, studentData.password || '')
                        .then((userCredential) => {
                          // Now delete this user account
                          return userCredential.user.delete();
                        })
                        .then(() => {
                          // Log back in as admin
                          return auth.signInWithEmailAndPassword(adminUser.email, adminPassword);
                        });
                    }
                    return Promise.resolve(); // No auth account to delete
                  })
                  .then(() => {
                    // Finally delete the Firestore document
                    return db.collection('users').doc(studentId).delete();
                  });
              })
              .then(() => {
                alert('Student account completely deleted from both database and authentication system!');
                loadStudents(); // Reload the table
              })
              .catch(error => {
                console.error('Error deleting student:', error);
                alert(`Error: ${error.message}`);
              });
          }
        });
      });
    }

    // Authentication and role-based access control
    auth.onAuthStateChanged((user) => {
      if (user) {
        // First, update user info in the UI
        document.getElementById('user-menu-btn').innerHTML = `
          <span class="sr-only">Open user menu</span>
          <img class="h-8 w-8 rounded-full object-cover" src="fst.png" alt="${user.email}">
        `;
        
        // Then check if user has appropriate role
        db.collection("users").doc(user.uid).get().then((docSnapshot) => {
          if (docSnapshot.exists) {
            const role = docSnapshot.data().role;

            if (role === "admin" || role === "teacher") {
              // Only load students if user has appropriate role
              loadStudents();
            } else {
              alert("Access denied. Only admins and teachers can access this page.");
              window.location.href = "home1.html";
            }
          } else {
            alert("No role assigned to this user.");
            window.location.href = "home1.html";
          }
        }).catch(error => {
          console.error("Error checking user role:", error);
          alert(`Error: ${error.message}`);
        });
      } else {
        window.location.href = "login.html";
      }
    });

    // Logout functionality
    document.getElementById('menu-logout').addEventListener('click', function() {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error('Error signing out:', error);
      });
    });
  </script>
</body>
</html>